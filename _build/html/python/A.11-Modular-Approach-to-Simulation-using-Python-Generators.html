
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modular Simulation using Python Generators &#8212; CBE 30338 Chemical Process Control</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Animation in Jupyter Notebooks" href="A.30-Animation-in-Jupyter-Notebooks.html" />
    <link rel="prev" title="Coding Controllers with Python Generators" href="A.10-Coding-Controllers-with-Python-Generators.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CBE 30338 Chemical Process Control</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Readme.html">
   CBE 30338 Chemical Process Control
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Syllabus.html">
   CBE 30338/32338 Syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Schedule.html">
   CBE 30338/32338 Schedule
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topical Materials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/01.00-What-is-Process-Control.html">
   1. What is Process Control?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/01.01-What-is-Feedback.html">
     1.1. What is Feedback?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/01.02-Elements-of-Feedback-Control.html">
     1.2. Elements of Process Control
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/02.00-Process-Modeling.html">
   2. Process Modeling
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/02.01-Properties-of-Scalar-First-Order-Linear-Systems.html">
     2.1. First-Order Linear Systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/02.02-One-Compartment-Pharmacokinetics.html">
     2.2. One Compartment Pharmacokinetics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/02.03-First-Order-Model-for-a-Single-Heater.html">
     2.3. First Order Model for a Single Heater
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/03.00-Feedback-Control.html">
   3. Feedback Control
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.01-Case-Study-Thermal-Cycling-PCR.html">
     3.1. Case Study: Thermal Cycling for PCR
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.02-Setpoints.html">
     3.2. Setpoints
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.03-Relay-Control.html">
     3.3. Relay Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.04-Implementing-Controllers.html">
     3.4. Implementing Controllers in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.05-Proportional-Integral-Control.html">
     3.5. Practical Proportional (P) and Proportional-Integral (PI) Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.06-Lab-Assignment-PI-Control.html">
     3.6. Lab Assignment 3: Relay and PI Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.07-Integral-Windup-and-Bumpless-Transfer.html">
     3.7. Integral Windup and Bumpless Transfer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.08-Lab-Assignment-Cascade-Control.html">
     3.8. Lab Assignment 4: Cascade Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/03.09-Lab-Assignment-Solution.html">
     3.9. Lab Assignment 4: Solution
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/04.00-Process-Analytics.html">
   4. Process Analytics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.01-Learning-Goals.html">
     4.1. Learning Goals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.02-Process-Historians.html">
     4.2. Data/Process/Operational Historian
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.03-State-Estimation-Copy1.html">
     4.3. Estimation and Anamoly Detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.03-State-Estimation.html">
     4.4. State Estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.04-Lab-Assigment-State-Estimation.html">
     4.5. Lab Assignment 5: State Estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.05-Anomaly-Detection.html">
     4.6. Anomaly Detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.06-Lab-Assignment-Anomaly-Detection.html">
     4.7. Lab Assignment 6: Anomaly Detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.07-Observer-Synthesis-LMI.html">
     4.8. Observer Synthesis using Linear Matrix Inequalities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.08-Envrironmental-Application.html">
     4.9. Application of Luenberger Observers to Environmental Modeling of Rivers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/04.09-Study-Questions.html">
     4.10. Study Questions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/05.00-Optimization.html">
   5. Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.01-Linear-Production-Model.html">
     5.1. Linear Production Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.02-Linear-Blending-Problem.html">
     5.2. Linear Blending Problems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.03-Homework_4.html">
     5.3. Homework Assignment 4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.04-Gasoline-Blending.html">
     5.4. Gasoline Blending
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.05-Linear-Programming.html">
     5.5. Linear Programming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.06-Design-of-a-Cold-Weather-Fuel.html">
     5.6. Design of a Cold Weather Fuel
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.98-Linear-Production-Model-in-Pyomo.html">
     5.7. Linear Production Model in Pyomo
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/05.99-Pyomo-Examples.html">
     5.8. Pyomo Examples
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/06.00-Predictive-Control.html">
   6. Predictive Control
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/06.01-Static-Operability.html">
     6.1. Static Operability
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/06.02-Simulation-and-Open-Loop-Optimal-Control.html">
     6.2. Simulation and Open-Loop Optimal Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/06.03-Predictive-Control.html">
     6.3. Predictive Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/06.04-Implementing-Predictive-Control.html">
     6.4. Implementing Predictive Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/06.05-Quiz-Review.html">
     6.5. Quiz Review for Chapters 5 and 6
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/07.00-Discrete-Event-Systems.html">
   7. Discrete Event Systems
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/07.01-Introduction-to-Simpy.html">
     7.1. Introduction to Simpy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/07.02-Agent-Based-Models.html">
     7.2. Agent Based Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/07.03-Chemotaxis.html">
     7.3. Chemotaxis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/07.04-Project-Batch-Chemical-Process.html">
     7.4. Batch Chemical Process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/07.05-Queuing-Systems-and-Poisson-Processes.html">
     7.5. Simulating Queuing Systems
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../notebooks/08.00-Projects.html">
   8. Projects
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../notebooks/08.01-Project-Ideas.html">
     8.1. Project Ideas
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../notebooks/09.00-Bibliography.html">
   9. References
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Control Laboratory
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/01.00-TCLab.html">
   1. The Temperature Control Laboratory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/01.01-Setting-Up-TCLab.html">
     1.1. Setting up TCLab
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/01.02-Troubleshooting-TCLab.html">
     1.2. Troubleshooting TCLab
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/01.03-Using-TCLab.html">
     1.3. Using TCLab
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/01.04-Assignment-Thermostat-Control.html">
     1.4. Assignment: Thermostat Control
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/02.00-Empirical-Model-Identification.html">
   2. Empirical Model Identification
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/02.01-Step-Testing.html">
     2.1. Step Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/02.02-Fitting-Step-Test-Data-to-Empirical-Models.html">
     2.2. Fitting Step Test Data to Empirical Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/02.03-First-Order-Model-for-a-Single-Heater.html">
     2.3. First Order Model for a Single Heater
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/03.00-Estimating-Model-Parameters.html">
   3. Estimating Model Parameters
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.04-Two-Input-Two-Output-Model.html">
     3.1. Two-Input, Two-Output Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.05-Two-State-Model-for-a-Single-Heater.html">
     3.2. Two State Model for a Single Heater
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.06-Four-State-Model.html">
     3.3. Four State Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.10-TCLab-Lab-2-Model-Indentification-Solutions.html">
     3.4. TCLab Lab 2: Model Identification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.10-TCLab-Lab-2-Model-Indentification.html">
     3.5. TCLab Lab 2: Model Identification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/03.11-TCLab-Lab-2-Fitting.html">
     3.6. Model Identification: Fitting models to data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/04.00-Feedback-Control.html">
   4. Feedback Control
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/04.01-Relay-Control.html">
     4.1. Relay Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/04.03-PID_Control.html">
     4.2. PID Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/04.10-Lab-Assignment-PID-Control.html">
     4.3. Lab Assignment: PID Control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/04.11-Lab-Assignment-PI-Control.html">
     4.4. Lab Assignment 4: PI Control
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/05.00-State-Estimation.html">
   5. State Estimation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/05.01-Open-and-Closed-Loop-Estimation.html">
     5.2. Open and Closed Loop Estimation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tclab/06.00-Optimal-Control.html">
   6. Optimization
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tclab/07.00-Predictive-Control-and-Real-Time-Optimization.html">
   7. Predictive Control and Real Time Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/07.01-Optimization-Control-and-Estimation-using-Pyomo.html">
     7.1. Simulation, Control, and Estimation using Pyomo
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tclab/07.02-Optimization-Control-and-Estimation-using-Pyomo-With-Windows-ipopt.html">
     7.2. Simulation, Control, and Estimation using Pyomo
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Python Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="A.00-Python-Tutorials.html">
   Python Tutorials
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="A.10-Coding-Controllers-with-Python-Generators.html">
     Coding Controllers with Python Generators
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Modular Simulation using Python Generators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="A.30-Animation-in-Jupyter-Notebooks.html">
     Animation in Jupyter Notebooks
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/python/A.11-Modular-Approach-to-Simulation-using-Python-Generators.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jckantor/cbe30338-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jckantor/cbe30338-book/issues/new?title=Issue%20on%20page%20%2Fpython/A.11-Modular-Approach-to-Simulation-using-Python-Generators.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/jckantor/cbe30338-book/main?urlpath=tree/python/A.11-Modular-Approach-to-Simulation-using-Python-Generators.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/jckantor/cbe30338-book/blob/main/python/A.11-Modular-Approach-to-Simulation-using-Python-Generators.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-using-scipy-integrate-odeint">
   Simulation using scipy.integrate.odeint()
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typical-usage">
     Typical Usage
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-wrong-with-that">
   What’s Wrong with That?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#python-generators">
   Python Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#yield-statement">
     Yield Statement
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterators">
     Iterators
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-way-communcation-with-generators-using-send">
     Two-way communcation with Generators using Send
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-application-modeling-gravity-drained-tanks-with-python-generators">
   Example Application: Modeling Gravity-Drained Tanks with Python Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generator-for-a-gravity-drained-tank">
     Generator for a Gravity-Drained Tank
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-a-single-tank-with-constant-inflow">
     Simulation of a Single Tank with Constant Inflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-two-tanks-in-series">
     Simulation of Two Tanks in Series
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-two-tanks-in-series-with-pi-level-control-on-the-second-tank">
     Simulation of Two Tanks in Series with PI Level Control on the Second Tank
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-pi-control-generator">
     Adding a PI Control Generator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementing-cascade-control-for-two-tanks-in-series-with-unmeasured-disturbance">
     Implementing Cascade Control for Two Tanks in Series with Unmeasured Disturbance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#enhancing-modularity-with-class-definitions-for-process-units">
   Enhancing Modularity with Class Definitions for Process Units
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gravity-drained-tank-class">
     Gravity-Drained Tank Class
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pi-controller-class">
     PI Controller Class
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modular-simulation-of-cascade-control-for-two-tanks-in-series">
     Modular Simulation of Cascade Control for Two Tanks in Series
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Modular Simulation using Python Generators</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-using-scipy-integrate-odeint">
   Simulation using scipy.integrate.odeint()
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typical-usage">
     Typical Usage
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-wrong-with-that">
   What’s Wrong with That?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#python-generators">
   Python Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#yield-statement">
     Yield Statement
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterators">
     Iterators
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-way-communcation-with-generators-using-send">
     Two-way communcation with Generators using Send
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-application-modeling-gravity-drained-tanks-with-python-generators">
   Example Application: Modeling Gravity-Drained Tanks with Python Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generator-for-a-gravity-drained-tank">
     Generator for a Gravity-Drained Tank
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-a-single-tank-with-constant-inflow">
     Simulation of a Single Tank with Constant Inflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-two-tanks-in-series">
     Simulation of Two Tanks in Series
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-of-two-tanks-in-series-with-pi-level-control-on-the-second-tank">
     Simulation of Two Tanks in Series with PI Level Control on the Second Tank
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-pi-control-generator">
     Adding a PI Control Generator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementing-cascade-control-for-two-tanks-in-series-with-unmeasured-disturbance">
     Implementing Cascade Control for Two Tanks in Series with Unmeasured Disturbance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#enhancing-modularity-with-class-definitions-for-process-units">
   Enhancing Modularity with Class Definitions for Process Units
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#gravity-drained-tank-class">
     Gravity-Drained Tank Class
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pi-controller-class">
     PI Controller Class
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modular-simulation-of-cascade-control-for-two-tanks-in-series">
     Modular Simulation of Cascade Control for Two Tanks in Series
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="modular-simulation-using-python-generators">
<h1>Modular Simulation using Python Generators<a class="headerlink" href="#modular-simulation-using-python-generators" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This notebook demonstrates shows how to use the Python generators for simulation. This technique implements simulation blocks as Python generators, and shows how to piece blocks together to simulate more complex systems. This is an advanced technique that may be useful in certain projects and a convenient alternative to block diagram simulators.</p>
</div>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#section1">Simulation using scipy.integrate.odeint()</a></p>
<ol class="simple">
<li><p><a class="reference external" href="#section1-1">Typical Usage</a></p></li>
<li><p><a class="reference external" href="#section1-2">What’s Wrong with That? </a><br><br></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#section2">Python Generators</a></p>
<ol class="simple">
<li><p><a class="reference external" href="#section2-1">Yield Statement</a></p></li>
<li><p><a class="reference external" href="#section2-2">Iterators</a></p></li>
<li><p><a class="reference external" href="#section2-3">Two-way communcation with Generators using Send</a><br><br></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#section3">Example Application: Modeling Gravity-Drained Tanks with Python Generators</a></p>
<ol class="simple">
<li><p><a class="reference external" href="#section3-1">Generator for a Gravity-Drained Tank</a></p></li>
<li><p><a class="reference external" href="#section3-2">Simulation of a Single Tank with Constant Inflow</a></p></li>
<li><p><a class="reference external" href="#section3-3">Simulation of Two Tanks in Series</a></p></li>
<li><p><a class="reference external" href="#section3-4">Simulation of Two Tanks in Series with PI Level Control on the Second Tank</a></p></li>
<li><p><a class="reference external" href="#section3-5">Adding a PI Control Generator</a></p></li>
<li><p><a class="reference external" href="#section3-6">Implementing Cascade Control for Two Tanks in Series with Unmeasured Disturbance</a><br><br></p></li>
</ol>
</li>
<li><p><a class="reference external" href="#section4">Enhancing Modularity with Class Definitions for Process Units</a></p>
<ol class="simple">
<li><p><a class="reference external" href="#section4-1">Gravity-Drained Tank Class</a></p></li>
<li><p><a class="reference external" href="#section4-2">PI Controller Class</a></p></li>
<li><p><a class="reference external" href="#section4-3">Modular Simulation of Cascade Control for Two Tanks in Series</a><br><br></p></li>
</ol>
</li>
</ol>
<p><a id='section1'></a></p>
</div>
<div class="section" id="simulation-using-scipy-integrate-odeint">
<h2>Simulation using scipy.integrate.odeint()<a class="headerlink" href="#simulation-using-scipy-integrate-odeint" title="Permalink to this headline">¶</a></h2>
<p><a id='section1-1'></a></p>
<div class="section" id="typical-usage">
<h3>Typical Usage<a class="headerlink" href="#typical-usage" title="Permalink to this headline">¶</a></h3>
<p>The SciPy library provides a convenient and familiar means of simulating systems modeled by systems of ordinary differential equations.  As demonstrated in other notebooks, the straightforward approach consists of several common steps</p>
<ol class="simple">
<li><p>Initialize graphics and import libraries</p></li>
<li><p>Fix parameter values</p></li>
<li><p>Write a function to evaluate RHS of the differential equations</p></li>
<li><p>Choose initial conditions and time grid</p></li>
<li><p>Perform the simulation by numerical solution of the differential equations</p></li>
<li><p>Prepare visualizations and post-processing</p></li>
</ol>
<p>Here we demonstrate this approach for a two gravity-drained tanks connected in series with constant inflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Initialize graphics and import libraries</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span>

<span class="c1"># 2. Fix parameter values</span>
<span class="n">A</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">Cv</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">qin</span> <span class="o">=</span> <span class="mf">0.4</span>

<span class="c1"># 3. Write a function to evaluate RHS of the differential equations</span>
<span class="k">def</span> <span class="nf">deriv</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">qin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">h1</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">X</span>
    <span class="n">dh1</span> <span class="o">=</span> <span class="p">(</span><span class="n">qin</span> <span class="o">-</span> <span class="n">Cv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h1</span><span class="p">))</span><span class="o">/</span><span class="n">A</span>
    <span class="n">dh2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">Cv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Cv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span><span class="o">/</span><span class="n">A</span> 
    <span class="k">return</span> <span class="p">[</span><span class="n">dh1</span><span class="p">,</span><span class="n">dh2</span><span class="p">]</span>

<span class="c1"># 4. Choose initial conditions and time grid</span>
<span class="n">IC</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># 5. Perform the simulation by numerical solution of the differential equations</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span><span class="n">IC</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">qin</span><span class="p">,))</span>

<span class="c1"># 6. Prepare visualizations and post-processing</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">sol</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Tank 1&#39;</span><span class="p">,</span><span class="s1">&#39;Tank 2&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulation of Two Gravity-Drained Tanks in Series&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_2_0.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_2_0.png" />
</div>
</div>
<p><a id='section1-2'></a></p>
</div>
</div>
<div class="section" id="what-s-wrong-with-that">
<h2>What’s Wrong with That?<a class="headerlink" href="#what-s-wrong-with-that" title="Permalink to this headline">¶</a></h2>
<p>If direct simulation as outlined above meets the needs of your project, then be satisfied and move on. This is how these tools are intended to be used.</p>
<p>However, as written above, simulation with scipy.integrate.odeint requires you to write a function that calculates the right hand side of a system of differential equations. This can be challenging for complex system. For example, you may have multiple PID controllers, each implementing logic for anti-reset windup. Or you may have components in the process that exhibit hysterisis, time-delay, or other difficult-to-model dynamics. These cases call for a more modular approach to modeling and simulation.</p>
<p>In these cases we’d like to combine the continous time dynamics modeled by differential equations with more complex logic executed at discrete points in the time.</p>
<p><a id='section2'></a></p>
</div>
<div class="section" id="python-generators">
<h2>Python Generators<a class="headerlink" href="#python-generators" title="Permalink to this headline">¶</a></h2>
<p><a id='section2-1'></a></p>
<div class="section" id="yield-statement">
<h3>Yield Statement<a class="headerlink" href="#yield-statement" title="Permalink to this headline">¶</a></h3>
<p>One of the more advanced and often overlooked features of Python is the use of <a class="reference external" href="http://nvie.com/posts/iterators-vs-generators/">generators and iterators</a> for performing operations on sequences of information. In particular, a generator is a function that returns information to via the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement rather then the more commonly encountered return statement. When called again, the generator picks right up at the point of the yield statement.</p>
<p>Let’s demonsrate this by writing a generator of Fibonacci numbers. This generator returns all Fibonacci numbers less or equal to a given number <span class="math notranslate nohighlight">\(n\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">j</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s a typical usage.  What are the Fibonacci numbers less than or equal to 100?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
1
2
3
5
8
13
21
34
55
89
</pre></div>
</div>
</div>
</div>
<p>The generator can also be used inside list comprehensions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987]
</pre></div>
</div>
</div>
</div>
<p><a id='section2-2'></a></p>
</div>
<div class="section" id="iterators">
<h3>Iterators<a class="headerlink" href="#iterators" title="Permalink to this headline">¶</a></h3>
<p>When called, a generator function creates an intermediate function called an iterator. Here we construct the iterator  and use it within a loop to find the first 10 Fibonacci numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
1
2
3
5
8
13
21
34
55
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">next</span></code> on an iterator returns the next value.</p>
<p><a id='section2-3'></a></p>
</div>
<div class="section" id="two-way-communcation-with-generators-using-send">
<h3>Two-way communcation with Generators using Send<a class="headerlink" href="#two-way-communcation-with-generators-using-send" title="Permalink to this headline">¶</a></h3>
<p>So far we have demonstrated the use of <code class="docutils literal notranslate"><span class="pre">yield</span></code> as a way to communicate information from the generator to the calling program. Which is fine if all you need is one-way communication. But for the modular simulation of processes, we need to be able to send information both ways.  A feedback control module, for example, will need to obtain current values of the process variable in order to update its internal state to provide an update of the manipulated variable to calling programm.</p>
<p>Here’s the definition of a generator for negative feedback proportional control where the control gain <span class="math notranslate nohighlight">\(K_p\)</span> and setpoint <span class="math notranslate nohighlight">\(SP\)</span> are specified constants.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">proportionalControl</span><span class="p">(</span><span class="n">Kp</span><span class="p">,</span><span class="n">SP</span><span class="p">):</span>
    <span class="n">MV</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">PV</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">MV</span>
        <span class="n">MV</span> <span class="o">=</span> <span class="n">Kp</span><span class="o">*</span><span class="p">(</span><span class="n">SP</span><span class="o">-</span><span class="n">PV</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement is now doing double duty.  When first called it sends the value of MV back to the calling program, then stops and waits. It is waiting for the calling program to send a value of PV using the <code class="docutils literal notranslate"><span class="pre">.send()</span></code> method. Execution resumes until the yield statement is encountered again and the new value of MV returned to the calling program.</p>
<p>With this behavior in mind, gettting the generator ready for use is a two step process. The first step is to create an instance (i.e., an iterator).  The second step is to initialize the instance by issuing <code class="docutils literal notranslate"><span class="pre">.send(None)</span></code> command.  This is will halt execution at the first <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement. At that point the generator instance will be ready to go for subsequent simulation.</p>
<p>Here’s the initialization of a new instance of proportional control with <span class="math notranslate nohighlight">\(K_p = 2.5\)</span> and <span class="math notranslate nohighlight">\(SP = 2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pc</span> <span class="o">=</span> <span class="n">proportionalControl</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pc</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This shows it in use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">PV</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">PV</span><span class="p">,</span> <span class="n">pc</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">PV</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 5.0
1 2.5
2 0.0
3 -2.5
4 -5.0
</pre></div>
</div>
</div>
</div>
<p>You can verify that these results satisfy the proportional control relationship.</p>
<p><a id='section3'></a></p>
</div>
</div>
<div class="section" id="example-application-modeling-gravity-drained-tanks-with-python-generators">
<h2>Example Application: Modeling Gravity-Drained Tanks with Python Generators<a class="headerlink" href="#example-application-modeling-gravity-drained-tanks-with-python-generators" title="Permalink to this headline">¶</a></h2>
<p>The first step in using a Python generator for simulation is to write the generator. It will be used to create instances of the dynamical process being modeled by the generator. Parameters should include a sample time <code class="docutils literal notranslate"><span class="pre">dt</span></code> and any other model parameters you choose to specify a particular instance of the process. The yield statement should provide time plus any other relevant process data. The yield statement will produce new values of process inputs valid for the next time step.</p>
<p><a id='section3-1'></a></p>
<div class="section" id="generator-for-a-gravity-drained-tank">
<h3>Generator for a Gravity-Drained Tank<a class="headerlink" href="#generator-for-a-gravity-drained-tank" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generator for a gravity-drained tank model</span>

<span class="k">def</span> <span class="nf">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">IC</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">qout</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Cv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">deriv</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="p">(</span><span class="n">qin</span> <span class="o">-</span> <span class="n">qout</span><span class="p">(</span><span class="n">h</span><span class="p">))</span><span class="o">/</span><span class="n">A</span>
        <span class="k">return</span> <span class="n">dh</span>
    
    <span class="n">h</span> <span class="o">=</span> <span class="n">IC</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">qin</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">t</span><span class="p">,</span><span class="n">qout</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">deriv</span><span class="p">,</span><span class="n">h</span><span class="p">,[</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
</div>
<p><a id='section3-2'></a></p>
</div>
<div class="section" id="simulation-of-a-single-tank-with-constant-inflow">
<h3>Simulation of a Single Tank with Constant Inflow<a class="headerlink" href="#simulation-of-a-single-tank-with-constant-inflow" title="Permalink to this headline">¶</a></h3>
<p>Next we show how to use the generator to create a simulation consisting of a single gravity drained tank with constant inflow.</p>
<ol class="simple">
<li><p>Choose a sample time for the simulation.</p></li>
<li><p>Create instances of the processes to be used in your simulation.</p></li>
<li><p>The first call to an instance is f.send(None). This will return the initial condition.</p></li>
<li><p>Subsequent calls to the instance should be f.send(u) where u is variable, tuple, or other data time being passed to the process. The return value will be a tuple contaning the next value of time plus other process data.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. select sample time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="c1"># 2. create a process instance</span>
<span class="n">tank</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="c1"># 3. get initial condition</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>

<span class="c1"># 4. append subsequent states </span>
<span class="n">y</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tank</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="p">)]</span>

<span class="c1"># 5. extract information into numpy arrays for plotting</span>
<span class="n">t</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Outlet Flow&#39;</span><span class="p">,</span><span class="s1">&#39;Level&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_24_0.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_24_0.png" />
</div>
</div>
<p><a id='section3-3'></a></p>
</div>
<div class="section" id="simulation-of-two-tanks-in-series">
<h3>Simulation of Two Tanks in Series<a class="headerlink" href="#simulation-of-two-tanks-in-series" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">tank1</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">tank2</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="n">y1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    
    <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span><span class="p">])</span>
    <span class="n">y2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span><span class="p">])</span>
    
<span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">h1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">h2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x111f5a7f0&gt;,
 &lt;matplotlib.lines.Line2D at 0x11213bf28&gt;]
</pre></div>
</div>
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_26_1.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_26_1.png" />
</div>
</div>
<p><a id='section3-4'></a></p>
</div>
<div class="section" id="simulation-of-two-tanks-in-series-with-pi-level-control-on-the-second-tank">
<h3>Simulation of Two Tanks in Series with PI Level Control on the Second Tank<a class="headerlink" href="#simulation-of-two-tanks-in-series-with-pi-level-control-on-the-second-tank" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">tank1</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">tank2</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="n">y1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>

<span class="n">u</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">r2</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">Kp</span> <span class="o">=</span> <span class="mf">.6</span>
<span class="n">Ki</span> <span class="o">=</span> <span class="mf">.6</span>
<span class="n">ecurr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ulog</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="p">]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    
    <span class="n">eprev</span><span class="p">,</span><span class="n">ecurr</span> <span class="o">=</span> <span class="n">ecurr</span><span class="p">,</span><span class="n">r2</span><span class="o">-</span><span class="n">h2</span>
    <span class="n">u</span> <span class="o">+=</span> <span class="n">Kp</span><span class="o">*</span><span class="p">(</span><span class="n">ecurr</span><span class="o">-</span><span class="n">eprev</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ki</span><span class="o">*</span><span class="n">ecurr</span><span class="o">*</span><span class="n">dt</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
    
    <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span><span class="p">])</span>
    <span class="n">y2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span><span class="p">])</span>
    <span class="n">ulog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    
<span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">h1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">h2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">ulog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x1123d0240&gt;]
</pre></div>
</div>
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_28_1.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_28_1.png" />
</div>
</div>
<p><a id='section3-5'></a></p>
</div>
<div class="section" id="adding-a-pi-control-generator">
<h3>Adding a PI Control Generator<a class="headerlink" href="#adding-a-pi-control-generator" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">PI_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">):</span>

    <span class="n">ecurr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eprev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">MVmin</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">t</span><span class="p">,</span><span class="n">u</span>
        <span class="n">eprev</span><span class="p">,</span><span class="n">ecurr</span> <span class="o">=</span> <span class="n">ecurr</span><span class="p">,</span><span class="n">r</span><span class="o">-</span><span class="n">y</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="n">Kp</span><span class="o">*</span><span class="p">(</span><span class="n">ecurr</span> <span class="o">-</span> <span class="n">eprev</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ki</span><span class="o">*</span><span class="n">ecurr</span><span class="o">*</span><span class="n">dt</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">MVmin</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">MVmax</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">tank1</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">tank2</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">PI_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">y1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">ulog</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>

<span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">t3</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span><span class="n">h2</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
    
    <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span><span class="p">])</span>
    <span class="n">y2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span><span class="p">])</span>
    <span class="n">ulog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    
<span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">h1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">h2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">ulog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x1124d7c50&gt;]
</pre></div>
</div>
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_31_1.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_31_1.png" />
</div>
</div>
<p><a id='section3-6'></a></p>
</div>
<div class="section" id="implementing-cascade-control-for-two-tanks-in-series-with-unmeasured-disturbance">
<h3>Implementing Cascade Control for Two Tanks in Series with Unmeasured Disturbance<a class="headerlink" href="#implementing-cascade-control-for-two-tanks-in-series-with-unmeasured-disturbance" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># disturbance function</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="c1"># simulation</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">tank1</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">tank2</span> <span class="o">=</span> <span class="n">gravtank_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="c1"># level control for tank 1.  </span>
<span class="n">pi1</span> <span class="o">=</span> <span class="n">PI_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># cascade level control for tank 2. Manipulated variable is the setpoint to pi1</span>
<span class="n">pi2</span> <span class="o">=</span> <span class="n">PI_generator</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">y1</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
<span class="n">ulog</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">pi2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">r2</span> <span class="o">=</span> <span class="mf">1.3</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">q1</span> <span class="o">+</span> <span class="n">d</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="n">t3</span><span class="p">,</span><span class="n">r1</span> <span class="o">=</span> <span class="n">pi2</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">r2</span><span class="p">,</span><span class="n">h2</span><span class="p">,</span><span class="n">r1</span><span class="p">))</span>
    <span class="n">t4</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">pi1</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">r1</span><span class="p">,</span><span class="n">h1</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
    
    <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span><span class="p">])</span>
    <span class="n">y2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span><span class="p">])</span>
    <span class="n">ulog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    
<span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">h1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">h2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">ulog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x1125c0710&gt;]
</pre></div>
</div>
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_33_1.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_33_1.png" />
</div>
</div>
<p><a id='section4'></a></p>
</div>
</div>
<div class="section" id="enhancing-modularity-with-class-definitions-for-process-units">
<h2>Enhancing Modularity with Class Definitions for Process Units<a class="headerlink" href="#enhancing-modularity-with-class-definitions-for-process-units" title="Permalink to this headline">¶</a></h2>
<p>One of the key goals of a modular approach to simulation is to implement process specific behavior within the definitions of the process, and separate from the organization of information flow among units that takes place in the main simulation loop.</p>
<p>Below we define two examples of class definitions demonstrating how this can be done. The class definitions add features for defining names and parameters for instances of each class, and functions to log and plot data gathered in the course of simulations.</p>
<p><a id='section4-1'></a></p>
<div class="section" id="gravity-drained-tank-class">
<h3>Gravity-Drained Tank Class<a class="headerlink" href="#gravity-drained-tank-class" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">gravtank</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cv</span> <span class="o">=</span> <span class="n">Cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qin</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">qout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qout</span><span class="p">(</span><span class="n">h</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span>
        <span class="k">return</span> <span class="n">dh</span>
    
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span><span class="n">qout</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">qout</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; qout&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; h&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">IC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">IC</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qin</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">qout</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deriv</span><span class="p">,</span><span class="n">h</span><span class="p">,[</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qout</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)])</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
</div>
<p><a id='section4-2'></a></p>
</div>
<div class="section" id="pi-controller-class">
<h3>PI Controller Class<a class="headerlink" href="#pi-controller-class" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PI</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kp</span> <span class="o">=</span> <span class="n">Kp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">=</span> <span class="n">Ki</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MVmin</span> <span class="o">=</span> <span class="n">MVmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MVmax</span> <span class="o">=</span> <span class="n">MVmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; PV&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; SP&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Process Variable and Setpoint&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; MV&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Manipulated Variable&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
        <span class="n">ecurr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eprev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MVmin</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">u</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">u</span><span class="p">])</span> 
            <span class="n">eprev</span><span class="p">,</span><span class="n">ecurr</span> <span class="o">=</span> <span class="n">ecurr</span><span class="p">,</span><span class="n">r</span><span class="o">-</span><span class="n">y</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="n">Kp</span><span class="o">*</span><span class="p">(</span><span class="n">ecurr</span> <span class="o">-</span> <span class="n">eprev</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ki</span><span class="o">*</span><span class="n">ecurr</span><span class="o">*</span><span class="n">dt</span>
            <span class="n">u</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MVmin</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MVmax</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
</div>
</div>
<p><a id='section4-3'></a></p>
</div>
<div class="section" id="modular-simulation-of-cascade-control-for-two-tanks-in-series">
<h3>Modular Simulation of Cascade Control for Two Tanks in Series<a class="headerlink" href="#modular-simulation-of-cascade-control-for-two-tanks-in-series" title="Permalink to this headline">¶</a></h3>
<p>The following simulation shows how to use the class definitions in a simulation.  Each process instance used in the simulation requires three actions:</p>
<ol class="simple">
<li><p>Create an instance of the process. This is the step at which you can provide an instance name, parameters specific to the process and instance. Methods associated with the instance will be used to examine simulation logs and plot simulation results.</p></li>
<li><p>Create a generator. A call to the generator function for each process instance creates an associated iterator. A sample time must be specified.</p></li>
<li><p>An initial call to the iterator with an argument of <code class="docutils literal notranslate"><span class="pre">None</span></code> is needed to advance execution to the first <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># disturbance function</span>
<span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="c1"># sample time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># create and initialize tank1</span>
<span class="n">tank1_obj</span> <span class="o">=</span> <span class="n">gravtank</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tank 1&#39;</span><span class="p">,</span><span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">tank1</span> <span class="o">=</span> <span class="n">tank1_obj</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># create and initailize tank2</span>
<span class="n">tank2_obj</span> <span class="o">=</span> <span class="n">gravtank</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tank 2&#39;</span><span class="p">,</span><span class="n">A</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">Cv</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">tank2</span> <span class="o">=</span> <span class="n">tank2_obj</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># level control for tank 1. </span>
<span class="n">pi1_obj</span> <span class="o">=</span> <span class="n">PI</span><span class="p">(</span><span class="s1">&#39;Tank 1&#39;</span><span class="p">,</span><span class="n">Kp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">pi1</span> <span class="o">=</span> <span class="n">pi1_obj</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="n">pi1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># cascade level control for tank 2. Manipulated variable is the setpoint to for pi1</span>
<span class="n">pi2_obj</span> <span class="o">=</span> <span class="n">PI</span><span class="p">(</span><span class="s1">&#39;Tank 2&#39;</span><span class="p">,</span><span class="n">Kp</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">MVmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MVmax</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pi2</span> <span class="o">=</span> <span class="n">pi2_obj</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
<span class="n">pi2</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># initial signals</span>
<span class="n">u</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1"># setpoint for tank 2 level</span>
<span class="n">r2</span> <span class="o">=</span> <span class="mf">1.3</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="n">qout1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">tank1</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
    <span class="n">qout2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">tank2</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">qout1</span> <span class="o">+</span> <span class="n">d</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">pi2</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">h2</span><span class="p">,</span><span class="n">r1</span><span class="p">))</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">pi1</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">h1</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>    

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">tank1_obj</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">tank2_obj</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">pi1_obj</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">pi2_obj</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_40_0.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_40_0.png" />
<img alt="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_40_1.png" src="../_images/A.11-Modular-Approach-to-Simulation-using-Python-Generators_40_1.png" />
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./python"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="A.10-Coding-Controllers-with-Python-Generators.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Coding Controllers with Python Generators</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="A.30-Animation-in-Jupyter-Notebooks.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Animation in Jupyter Notebooks</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Jeffrey Kantor<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>